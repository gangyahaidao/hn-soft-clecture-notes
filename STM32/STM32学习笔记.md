## STM32学习笔记

> 作者：刚牙海盗  时间：2019年1月12日

### 第1章【为什么学习STM32】

#### 1.1 嵌入式技术知识体系

嵌入式技术是专用计算机系统技术，它以应用为核心，以计算机技术为基础，软硬件均可裁剪，适用在对功能、稳定性、功耗有严格限制的系统中。嵌入式技术的开发人员需要对整个计算机体系（从底层硬件到软件操作系统）都有了解，结构图如下：

<img src="C:\Users\My\AppData\Roaming\Typora\typora-user-images\image-20200112104203148.png" alt="image-20200112104203148" style="zoom:80%;" />

#### 1.2 嵌入式工程师成长之路

##### 1.2.1 如何从学生成为工程师

越往底层越接近硬件，越往上层越偏向软件，但是并不代表嵌入式技术人员不需要 了解硬件，相反，上层的知识都是以底层为基础的，即**”做嵌入式软件开发至少要读懂电路原理图“**；

在嵌入式技术领域的公司，除了工程师还分很多职业岗位，一般公司的研发部门职位如下图：

<img src="C:\Users\My\AppData\Roaming\Typora\typora-user-images\image-20200112105237754.png" alt="image-20200112105237754" style="zoom:80%;" />

一般需要3~5年才能积攒足够的知识和经验过渡到下一个阶段，在小公司里项目经理一般也兼任部门经理，系统架构师和开发工程师则与技术直接相关，根据大小公司不同，对开发人员的需求也不一样，一般小公司（20~200人）跟喜欢招熟悉软硬件的跨领域工程师；而大公司分工明确，更看重在某领域研究得深入的开发工程师；而系统架构师则需要熟悉整个嵌入式领域，能协调不同领域的开发工程师进行项目的开发。

##### 1.2.2 为什么要介绍大家学习STM32

- 在嵌入式领域STM32芯片介于低端和高端之间，它相比于普通的8/16位单片机有更多的外设，更先进的内核架构，可以运行uC/OS等实时操作系统；
- 相比于可运行Linux操作系统的高端CPU，其成本低，实时性强，这使得STM32占领了大部分中低端控制器的市场，可以成为提升开发技术的优良过渡平台，为后续的学习打下坚实的基础；
- STM32开发使用了类库，可以锻炼大家的C语言运用能力，具备系统工程级代码开发能力；STM32是我们后面做一些项目的主控器，比如四旋翼、自动寻迹机器人等。

##### 1.2.3 如何学习STM32

由于STM32的开发方式较普通单片机有一些不同，所以学习时主要注意下面几点：

1. 转变思维，适应使用固件库开发的方式，加强运用C语言的能力，建立工程意识；
2. 熟悉Contex-M系列芯片架构，熟悉STM32系统的总线结构；
3. 熟悉IIC、SPI、SDIO、CAN、TCP/IP等各种通信协议，这些协议就像硬件之间相互沟通的“语言”，掌握这些协议，开发软件驱动就容易了；
4. 前期学习一定要结合硬件开发板亲自编程调试；
5. 无需太担心自己的基础，需要的是否有学习的勇气，拿下STM32的决心；

---



## 第2章【初识STM32库】

本章通过介绍STM32固件库的各个文件以及文件之间的关系，让大家建立STM32固件库的整体概念，不需要完全掌握，只需要有印象即可。

### 2.1 必须要了解的CMSIS标准

1. ARM公司不生产芯片，只出售芯片授权，基于Cortex的系列芯片采用内核都是相同的，但是不同授权厂家基于此内核设计出各种各样外设硬件的系统，内核与外设的关系，类似PC上的CPU与主板、内存、显卡、硬盘等的关系，而这些差异导致软件在同内核、不同外设的芯片上移植困难，不能通用；
2. 为了解决不同芯片生产厂商Contex微控制器软件的兼容性问题，ARM与芯片厂商建立了CMSIS标准；
3. 所谓CMSIS标准，实际上是建立了一个软件抽象层，用一套软件代码啦兼容各种不同的硬件，意义非常重大；
4. 结构图如下：

<img src="C:\Users\My\AppData\Roaming\Typora\typora-user-images\image-20200112141838995.png" alt="image-20200112141838995" style="zoom:80%;" />

```
标准中最主要是CMSIS核心层，它包括：
· 内核函数层：其中包含用于访问内核寄存器的名称、地址定义等，主要由ARM提供；
· 设备外设访问层：提供片上核外外设的地址和中断定义，主要由芯片厂商提供；
所以CMSIS层位于硬件层与用户层之间，提供了与硬件生产厂商无关的硬件抽象层，可以为接口外设、实时操作系统提供简单易用的处理器软件接口，屏蔽了硬件差异，极大方便了软件移植。STM32固件库就是按照CMSIS标准建立的。
```

#### 2.2 固件库目录、文件简介

##### 2.2.1 固件库下载

```
https://www.st.com/zh/embedded-software/stm32-standard-peripheral-libraries.html
https://blog.csdn.net/athen21/article/details/83585087
```

- <img src="C:\Users\My\AppData\Roaming\Typora\typora-user-images\image-20200112144132973.png" alt="image-20200112144132973" style="zoom:80%;" />

- [ ] Libraries文件夹是驱动库的源代码及启动文件
- [ ] Project文件夹下是用驱动库写的例子和一个工程模板
- [ ] 库帮助文档，讲述如何使用库来编写自己的应用程序

**库如何使用：**

- 使用库开发时，我们需要把Libraries目录下的库函数文件添加到工程中，并查阅库帮助文档来了解硬件生产厂商ST提供的库函数
- 进入Libraries文件夹看到，关于内核与外设的库文件分别存放在CMSIS和STM32F10x_StdPeriph_Driver文件夹中，其中Libraries\CMSIS\CM3中又存放CoreSupport和DeviceSupport文件夹
- 介绍几个非常重要的文件
  - core_cm3.c文件和core_cm3.h文件
    - 位于CoreSupport文件夹中，是位于CMSIS标准的核内设备函数层CM3核通用的源文件，它们的作用是为采用Cortex-M3核设计SoC的芯片商设计的芯片外设提供一个进入CM3内核的接口；
    - 对于其他公司的CM3系列芯片这两个文件也是相同的，这两个文件是底层文件，由AMR公司提供，使得不同CM3芯片的移植工作就得到简化；
  - system_stm32f10x.c文件
    - 位于DeviceSupport文件夹中，由ST公司提供，该文件功能是设置系统时钟和总线时钟，使用PLL（锁相环）技术来实现，这需要操作寄存器，而寄存器是以存储器的形式来访问的，为了方便访问寄存器包含了stm32f10x.h文件
  - stm32f10x.h文件
    - 这是一个非常重要非常底层的文件，包含了STM32中寄存器地址和结构体定义，在使用到STM32固件库的地方都需要包含这个文件
  - 启动文件
    - 位于Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F10x\startup\arm文件夹，由汇编语言编写的系统启动文件，不同文件对应不同的芯片型号；
    - 启动文件作用：启动文件是任何处理器在上电复位之后最先运行的一段汇编程序，系统在运行我们编写的C语言代码之前，需要汇编语言为C语言的运行建立一个合适的环境，之后才能运行我们的程序，所以我们要在代码工程中加入启动文件；
    - 总之，启动文件作用是：
      - 初始化堆栈指针SP
      - 初始化程序计数器指针CP
      - 设置堆、栈的大小
      - 设置异常向量表的入口地址
      - 配置外部SRAM作为数据存储器（如果有的话）
      - 设置执行C程序的入口__main
      - 配置系统时钟
  - STM32F10x_StdPeriph_Driver文件夹
    - 此文件夹包含inc和src两个子文件夹，src是每个设备外设的驱动程序，是芯片制造厂商在Contex-M3内核外加进去的
    - 如果我们在编程的时候用到了板上的资源，则需要把相应的驱动文件加入工程中
    - 注意一个特殊文件misc.c文件，此文件提供了外设对内核NVIC中断向量控制器的访问函数，在配置中断时，我们必须要把这个文件加入工程中
  - stm32f10x_it.c和stm32f10x_conf.h文件
    - 位于Project\STM32F10x_StdPeriph_Template目录中，存放了一个官方库工程模板，我们在用库创建一个使用库的工程时，需要加入这个目录下的文件
    - 主要是用来编写系统中断代码和相关外设的头文件等
- 各个库文件与CMSIS关系：

![image-20200112154142483](C:\Users\My\AppData\Roaming\Typora\typora-user-images\image-20200112154142483.png)

>  **如何使用库文档**
>
> 1. 会查就行
> 2. 操作不同的硬件外设就查询帮助手册中对应的部分

---



## 第3章【入门GPIO流水灯】

#### 3.1 安装MDK集成开发环境



